#!/bin/bash
set -euxo pipefail

APP_USER="${app_user}"
WORKDIR="${working_dir}"
REPO_URL="${repo_url}"
SERVICE_NAME="${service_name}"
NODE_MAJOR="${node_version}"
USE_SECRET_MANAGER="${use_secret_manager}"
PROJECT_ID="${project_id}"
SECRET_ID="${secret_id}"

log() {
  echo "[$(date --iso-8601=seconds)] $1"
}

if ! id -u "${APP_USER}" >/dev/null 2>&1; then
  useradd --create-home --shell /bin/bash "${APP_USER}"
fi

apt-get update
DEBIAN_FRONTEND=noninteractive apt-get upgrade -y
DEBIAN_FRONTEND=noninteractive apt-get install -y \
  ca-certificates \
  curl \
  git \
  gnupg \
  build-essential \
  python3

curl -fsSL "https://deb.nodesource.com/setup_${NODE_MAJOR}.x" | bash -
DEBIAN_FRONTEND=noninteractive apt-get install -y nodejs

install -d -o "${APP_USER}" -g "${APP_USER}" "${WORKDIR}"

if [ ! -d "${WORKDIR}/.git" ]; then
  runuser -u "${APP_USER}" -- git clone "${REPO_URL}" "${WORKDIR}"
else
  runuser -u "${APP_USER}" -- git -C "${WORKDIR}" pull --ff-only
fi

runuser -u "${APP_USER}" -- npm --prefix "${WORKDIR}" ci || \
  runuser -u "${APP_USER}" -- npm --prefix "${WORKDIR}" install
runuser -u "${APP_USER}" -- npm --prefix "${WORKDIR}" run build

cat <<EOF_SERVICE >/etc/systemd/system/${SERVICE_NAME}.service
[Unit]
Description=Tatekae Seisan Bot
After=network.target

[Service]
Type=simple
WorkingDirectory=${WORKDIR}
EnvironmentFile=${WORKDIR}/.env
ExecStart=/usr/bin/node dist/index.js
Restart=always
User=${APP_USER}

[Install]
WantedBy=multi-user.target
EOF_SERVICE

chown root:root /etc/systemd/system/${SERVICE_NAME}.service
chmod 644 /etc/systemd/system/${SERVICE_NAME}.service

if [ "${USE_SECRET_MANAGER}" = "true" ] && [ -n "${SECRET_ID}" ]; then
  TOKEN=$(curl -s -H "Metadata-Flavor: Google" \
    "http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token" \
    | python3 -c 'import json,sys; print(json.load(sys.stdin)["access_token"])')
  curl -s -H "Authorization: Bearer ${TOKEN}" \
    "https://secretmanager.googleapis.com/v1/projects/${PROJECT_ID}/secrets/${SECRET_ID}/versions/latest:access" \
    | python3 -c 'import json,sys; print(json.load(sys.stdin)["payload"]["data"])' \
    | base64 --decode > "${WORKDIR}/.env"
  chown "${APP_USER}:${APP_USER}" "${WORKDIR}/.env"
  chmod 600 "${WORKDIR}/.env"
  log "Fetched .env from Secret Manager secret ${SECRET_ID}."
else
  if [ ! -f "${WORKDIR}/.env" ]; then
    cat <<'EOF_ENV' > "${WORKDIR}/.env"
# TODO: Populate this file with Slack and Google credentials before starting the bot.
EOF_ENV
    chown "${APP_USER}:${APP_USER}" "${WORKDIR}/.env"
    chmod 600 "${WORKDIR}/.env"
    log "Created placeholder ${WORKDIR}/.env; replace with real secrets."
  fi
fi

systemctl daemon-reload
systemctl enable --now "${SERVICE_NAME}"
